name: Keep RedBot VM Alive

on:
  schedule:
    - cron: "*/1 * * * *"   # Every 5 minutes
  workflow_dispatch:        # Allow manual run

jobs:
  keepalive:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Check VM state
        id: check
        uses: azure/CLI@v2
        with:
          inlineScript: |
            STATE=$(az vm get-instance-view \
              --resource-group $AZURE_RESOURCE_GROUP \
              --name $AZURE_VM_NAME \
              --query "instanceView.statuses[?starts_with(code, 'PowerState/')].code" \
              -o tsv)

            echo "VM state: $STATE"

            if [ "$STATE" != "PowerState/running" ]; then
              echo "vm_not_running=true" >> $GITHUB_OUTPUT
            else
              echo "vm_not_running=false" >> $GITHUB_OUTPUT
            fi
        env:
          AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
          AZURE_VM_NAME: ${{ secrets.AZURE_VM_NAME }}

      - name: Start VM if needed
        if: steps.check.outputs.vm_not_running == 'true'
        uses: azure/CLI@v2
        with:
          inlineScript: |
            echo "Starting VM $AZURE_VM_NAME in $AZURE_RESOURCE_GROUP..."
            az vm start \
              --resource-group $AZURE_RESOURCE_GROUP \
              --name $AZURE_VM_NAME
        env:
          AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
          AZURE_VM_NAME: ${{ secrets.AZURE_VM_NAME }}
          
